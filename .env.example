# =============================================================================
# ARO - Appointment Revenue Optimizer
# Environment Configuration Template
# =============================================================================
# Copy this file to .env and fill in all values.
# All variables are REQUIRED unless marked OPTIONAL.
# The application will FAIL TO START if any required variable is missing.
# =============================================================================

# -----------------------------------------------------------------------------
# SERVER CONFIGURATION
# -----------------------------------------------------------------------------
# Environment: development, test, staging, production
NODE_ENV=development

# Server port (must be a valid port number)
PORT=3000

# Server host (use 0.0.0.0 for external access, 127.0.0.1 for localhost only)
HOST=127.0.0.1

# Log level: trace, debug, info, warn, error, fatal
LOG_LEVEL=info

# -----------------------------------------------------------------------------
# DATABASE CONFIGURATION
# -----------------------------------------------------------------------------
# PostgreSQL connection URL (required for production)
# Format: postgresql://user:password@host:port/database?sslmode=require
DATABASE_URL=postgresql://aro_user:password@localhost:5432/aro_db

# Connection pool settings
DATABASE_POOL_MIN=2
DATABASE_POOL_MAX=10

# Database SSL mode (required for production: require, optional for dev: disable)
DATABASE_SSL_MODE=disable

# Migration lock timeout in milliseconds
DATABASE_MIGRATION_LOCK_TIMEOUT=30000

# Core async command bus durability and worker controls
CORE_COMMAND_QUEUE_FILE=.data/core-command-queue.json
CORE_DISPATCH_WORKER_INTERVAL_MS=1000
CORE_DISPATCH_WORKER_MAX_ATTEMPTS=3

# -----------------------------------------------------------------------------
# OPENCLAW EXECUTOR INTEGRATION
# -----------------------------------------------------------------------------
# Internal OpenClaw executor base URL used by core-engine for side-effect execution
OPENCLAW_EXECUTOR_URL=http://127.0.0.1:3200

# Shared bearer token used for Core->Executor service authentication
OPENCLAW_SHARED_TOKEN=your-openclaw-shared-token-minimum-16-chars

# Shared bearer token used by trusted services (profile backends) to call core command/event APIs
CORE_SERVICE_SHARED_TOKEN=your-core-service-shared-token-minimum-16-chars

# Required permission manifest version for core-authorized execution commands
OPENCLAW_PERMISSION_MANIFEST_VERSION=1.0.0

# Allowed executor command types (comma-separated)
OPENCLAW_ALLOWED_COMMANDS=integration.twilio.send_sms,integration.booking.request_reschedule_link,integration.payments.generate_deposit_link,integration.nlp.classify_reply

# Allowed tenant IDs for executor authorization (comma-separated)
OPENCLAW_ALLOWED_TENANTS=tenant-default,tenant-health-1

# Per-tenant execution rate limit per minute
OPENCLAW_TENANT_RATE_LIMIT_PER_MINUTE=120

# Persistent idempotency store file path for executor command outcomes
OPENCLAW_IDEMPOTENCY_STORE_FILE=.data/openclaw-executor-idempotency.json

# Persistent outbox file path for executor-emitted canonical events
OPENCLAW_OUTBOX_FILE=.data/openclaw-executor-outbox.json

# Executor runtime mode: external_cli or gateway_tools_invoke
OPENCLAW_RUNTIME_MODE=gateway_tools_invoke

# Required for external_cli mode
OPENCLAW_AGENT_ID=aro-executor-agent
OPENCLAW_AGENT_TIMEOUT_SECONDS=30
OPENCLAW_AGENT_LOCAL_MODE=false

# Required for gateway_tools_invoke mode
OPENCLAW_GATEWAY_URL=http://127.0.0.1:4100
OPENCLAW_GATEWAY_TOKEN=your-openclaw-gateway-token
# JSON map from core command type -> gateway tool/action
OPENCLAW_GATEWAY_TOOL_MAPPINGS={"integration.twilio.send_sms":{"tool":"twilio_tool","action":"send_sms"},"integration.booking.request_reschedule_link":{"tool":"booking_tool","action":"request_reschedule_link"},"integration.payments.generate_deposit_link":{"tool":"payments_tool","action":"generate_deposit_link"},"integration.nlp.classify_reply":{"tool":"nlp_tool","action":"classify_reply"}}

# -----------------------------------------------------------------------------
# HEALTHCARE PROFILE BACKEND
# -----------------------------------------------------------------------------
# Healthcare profile backend bind host/port
PROFILE_BACKEND_HOST=127.0.0.1
PROFILE_BACKEND_PORT=4301

# Tenant boundary enforced by healthcare profile backend
PROFILE_BACKEND_TENANT_ID=tenant-health-1

# Shared token used by healthcare profile backend to call core-engine
PROFILE_BACKEND_SHARED_TOKEN=your-profile-backend-shared-token-min-16

# Core engine URL used by profile backend for command/event flows
CORE_ENGINE_URL=http://127.0.0.1:3100

# Supabase project URL and anonymous key for healthcare user authentication
SUPABASE_URL=https://your-project-ref.supabase.co
SUPABASE_ANON_KEY=your-supabase-anon-key

# Comma-separated application roles allowed to invoke profile healthcare APIs
PROFILE_BACKEND_ALLOWED_ROLES=admin,staff

# -----------------------------------------------------------------------------
# SECURITY - AUTHENTICATION
# -----------------------------------------------------------------------------
# JWT secret for admin authentication (minimum 32 characters)
# Generate with: openssl rand -base64 32
JWT_SECRET=your-jwt-secret-minimum-32-characters-long

# JWT token expiration (e.g., 24h, 7d, 30m)
JWT_EXPIRES_IN=24h

# Session secret for cookie signing (minimum 32 characters)
SESSION_SECRET=your-session-secret-minimum-32-characters-long

# Password pepper for hashing (minimum 32 characters)
PASSWORD_PEPPER=your-password-pepper-minimum-32-characters

# -----------------------------------------------------------------------------
# SECURITY - ENCRYPTION
# -----------------------------------------------------------------------------
# Master encryption key for sensitive field encryption
# Must be exactly 64 hex characters (32 bytes)
# Generate with: openssl rand -hex 32
ENCRYPTION_KEY=your-64-character-hex-encryption-key-here-0000000000000000

# Encryption salt (minimum 16 characters)
# Generate with: openssl rand -base64 16
ENCRYPTION_SALT=your-encryption-salt

# -----------------------------------------------------------------------------
# CALENDLY INTEGRATION
# -----------------------------------------------------------------------------
# Calendly API key (starts with 'Bearer ')
# Find at: https://calendly.com/integrations/api_webhook
CALENDLY_API_KEY=Bearer your-calendly-api-token

# Calendly webhook signing secret (for signature verification)
# Generated when creating a webhook in Calendly
CALENDLY_WEBHOOK_SECRET=your-calendly-webhook-signing-secret-32-chars

# Calendly organization URI (optional, for filtering)
# Format: https://api.calendly.com/organizations/XXXXXXX
CALENDLY_ORGANIZATION_URI=

# -----------------------------------------------------------------------------
# TWILIO INTEGRATION (SMS/WhatsApp)
# -----------------------------------------------------------------------------
# Twilio Account SID (starts with 'AC')
TWILIO_ACCOUNT_SID=ACxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

# Twilio Auth Token (32 characters)
TWILIO_AUTH_TOKEN=your-twilio-auth-token-32-characters

# Twilio phone number in E.164 format
TWILIO_PHONE_NUMBER=+15551234567

# Optional: WhatsApp enabled number (same format)
TWILIO_WHATSAPP_NUMBER=+15551234567

# Twilio webhook validation enabled (true/false)
TWILIO_VALIDATE_WEBHOOKS=true

# -----------------------------------------------------------------------------
# STRIPE INTEGRATION (Payments)
# -----------------------------------------------------------------------------
# Stripe secret key (sk_test_... for test, sk_live_... for production)
STRIPE_SECRET_KEY=sk_test_your-stripe-secret-key

# Stripe webhook signing secret (starts with 'whsec_')
STRIPE_WEBHOOK_SECRET=whsec_your-stripe-webhook-secret

# Stripe API version (for consistent API behavior)
STRIPE_API_VERSION=2023-10-16

# Optional: Currency for payments (default: USD)
STRIPE_CURRENCY=USD

# -----------------------------------------------------------------------------
# LLM CONFIGURATION (Classification Only)
# -----------------------------------------------------------------------------
# LLM provider: anthropic, openai
LLM_PROVIDER=anthropic

# API key for LLM provider
LLM_API_KEY=your-llm-api-key

# Model identifier
# Anthropic: claude-3-haiku-20240307, claude-3-sonnet-20240229
# OpenAI: gpt-4o-mini, gpt-4o
LLM_MODEL=claude-3-haiku-20240307

# Maximum tokens for classification responses (keep low for cost control)
LLM_MAX_TOKENS=50

# Temperature for classification (keep low for consistency: 0.0-0.3)
LLM_TEMPERATURE=0.1

# LLM request timeout in milliseconds
LLM_TIMEOUT=10000

# -----------------------------------------------------------------------------
# WORKFLOW CONFIGURATION
# -----------------------------------------------------------------------------
# Enable workflow engine (true/false)
WORKFLOW_ENABLED=true

# Maximum concurrent workflows
WORKFLOW_MAX_CONCURRENT=100

# Workflow retry attempts for transient failures
WORKFLOW_RETRY_ATTEMPTS=3

# Workflow retry delay base in milliseconds (exponential backoff)
WORKFLOW_RETRY_DELAY_BASE=1000

# Dead letter queue retention days
WORKFLOW_DLQ_RETENTION_DAYS=30

# -----------------------------------------------------------------------------
# REMINDER CONFIGURATION
# -----------------------------------------------------------------------------
# First reminder offset in hours before appointment
REMINDER_48H_OFFSET_HOURS=48

# Second reminder offset in hours before appointment
REMINDER_24H_OFFSET_HOURS=24

# Review request offset in hours after appointment
REVIEW_REQUEST_OFFSET_HOURS=6

# Maximum messages per customer per 24 hours (TCPA compliance)
MESSAGE_RATE_LIMIT_PER_DAY=3

# Message opt-out footer (appended to all SMS)
MESSAGE_OPT_OUT_FOOTER=Reply STOP to unsubscribe.

# -----------------------------------------------------------------------------
# GUARDRAILS (CRITICAL - DO NOT DISABLE IN PRODUCTION)
# -----------------------------------------------------------------------------
# Prevent automatic appointment cancellation (must be true)
GUARDRAIL_PREVENT_AUTO_CANCELLATION=true

# Prevent automatic payment processing (must be true)
GUARDRAIL_PREVENT_AUTO_PAYMENT=true

# Maximum messages per customer per day
GUARDRAIL_MESSAGE_RATE_LIMIT=3

# -----------------------------------------------------------------------------
# RATE LIMITING
# -----------------------------------------------------------------------------
# API rate limit: requests per minute
RATE_LIMIT_API_PER_MINUTE=100

# Webhook rate limit: requests per minute per IP
RATE_LIMIT_WEBHOOK_PER_MINUTE=1000

# Admin API rate limit: requests per minute
RATE_LIMIT_ADMIN_PER_MINUTE=60

# -----------------------------------------------------------------------------
# CIRCUIT BREAKER CONFIGURATION
# -----------------------------------------------------------------------------
# Circuit breaker: failure threshold before opening
CIRCUIT_BREAKER_FAILURE_THRESHOLD=5

# Circuit breaker: reset timeout in milliseconds
CIRCUIT_BREAKER_RESET_TIMEOUT=30000

# Circuit breaker: half-open state max requests
CIRCUIT_BREAKER_HALF_OPEN_MAX=3

# -----------------------------------------------------------------------------
# IDEMPOTENCY CONFIGURATION
# -----------------------------------------------------------------------------
# Idempotency key retention in hours
IDEMPOTENCY_KEY_RETENTION_HOURS=72

# Enable idempotency for webhooks (recommended: true)
IDEMPOTENCY_WEBHOOKS_ENABLED=true

# -----------------------------------------------------------------------------
# AUDIT LOGGING
# -----------------------------------------------------------------------------
# Enable audit logging (recommended: true)
AUDIT_ENABLED=true

# Audit log retention in days (7 years = 2555 days for regulatory compliance)
AUDIT_RETENTION_DAYS=2555

# Include request bodies in audit logs (caution: may contain sensitive data)
AUDIT_LOG_REQUEST_BODIES=false

# -----------------------------------------------------------------------------
# CORS CONFIGURATION
# -----------------------------------------------------------------------------
# Allowed origins for CORS (comma-separated)
CORS_ORIGINS=http://localhost:3000,http://localhost:5173

# CORS credentials enabled (true/false)
CORS_CREDENTIALS=true

# -----------------------------------------------------------------------------
# TLS/SSL CONFIGURATION (Production)
# -----------------------------------------------------------------------------
# Enable TLS (required for production)
TLS_ENABLED=false

# Path to TLS certificate file
TLS_CERT_PATH=/path/to/cert.pem

# Path to TLS private key file
TLS_KEY_PATH=/path/to/key.pem

# Minimum TLS version (TLSv1.2 or TLSv1.3)
TLS_MIN_VERSION=TLSv1.2

# -----------------------------------------------------------------------------
# BACKUP CONFIGURATION
# -----------------------------------------------------------------------------
# Enable automatic backups
BACKUP_ENABLED=true

# Backup schedule (cron format)
BACKUP_SCHEDULE=0 2 * * *

# Backup retention in days
BACKUP_RETENTION_DAYS=30

# Backup encryption enabled
BACKUP_ENCRYPTION_ENABLED=true

# Backup output directory
BACKUP_OUTPUT_DIR=/var/backups/aro

# -----------------------------------------------------------------------------
# MONITORING (OPTIONAL)
# -----------------------------------------------------------------------------
# Health check path (default: /health)
HEALTH_CHECK_PATH=/health

# Readiness check path (default: /ready)
READINESS_CHECK_PATH=/ready

# Metrics enabled (true/false)
METRICS_ENABLED=false

# Metrics port (if different from main port)
METRICS_PORT=9090

# -----------------------------------------------------------------------------
# OPTIONAL: EXTERNAL SERVICES
# -----------------------------------------------------------------------------
# Sentry DSN for error tracking (optional)
SENTRY_DSN=

# Slack webhook URL for alerts (optional)
SLACK_WEBHOOK_URL=

# Email configuration for alerts (optional)
SMTP_HOST=
SMTP_PORT=587
SMTP_USER=
SMTP_PASSWORD=
ALERT_EMAIL_FROM=
ALERT_EMAIL_TO=

# =============================================================================
# PRODUCTION CHECKLIST
# =============================================================================
# Before deploying to production, ensure ALL of the following:
#
# [ ] NODE_ENV=production
# [ ] All secrets are strong (min 32 characters for secrets, 64 hex for encryption)
# [ ] DATABASE_URL uses SSL (sslmode=require)
# [ ] TLS_ENABLED=true with valid certificates
# [ ] GUARDRAIL_PREVENT_AUTO_CANCELLATION=true
# [ ] GUARDRAIL_PREVENT_AUTO_PAYMENT=true
# [ ] STRIPE_SECRET_KEY starts with sk_live_
# [ ] All optional services configured as needed
# [ ] No test/default credentials in use
# =============================================================================
